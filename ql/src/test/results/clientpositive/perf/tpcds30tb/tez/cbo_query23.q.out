CTE Suggestion:
HiveProject($f1=[$0])
  HiveFilter(condition=[>($2, 4)])
    HiveProject(i_item_sk=[$3], d_date=[$1], $f2=[$2])
      HiveJoin(condition=[=($0, $3)], joinType=[inner], algorithm=[none], cost=[not available])
        HiveAggregate(group=[{0, 3}], agg#0=[count()])
          HiveJoin(condition=[=($1, $2)], joinType=[inner], algorithm=[none], cost=[not available])
            HiveProject(ss_item_sk=[$1], ss_sold_date_sk=[$22])
              HiveFilter(condition=[IS NOT NULL($22)])
                HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales])
            HiveProject(d_date_sk=[$0], d_date=[$2])
              HiveFilter(condition=[SEARCH($6, Sarg[1999, 2000, 2001, 2002])])
                HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])
        HiveProject(i_item_sk=[$0])
          HiveTableScan(table=[[default, item]], table:alias=[item])

CTE Suggestion:
HiveProject(c_customer_sk=[$0])
  HiveJoin(condition=[>($1, $2)], joinType=[inner], algorithm=[none], cost=[not available])
    HiveFilter(condition=[IS NOT NULL($1)])
      HiveAggregate(group=[{0}], agg#0=[sum($1)])
        HiveProject(ss_customer_sk=[CAST($2):BIGINT NOT NULL], $f1=[*(CAST($9):DECIMAL(10, 0), $12)])
          HiveFilter(condition=[IS NOT NULL($2)])
            HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales])
    HiveProject(EXPR$0=[*(0.95:DECIMAL(16, 6), $0)])
      HiveFilter(condition=[IS NOT NULL($0)])
        HiveAggregate(group=[{}], agg#0=[max($1)])
          HiveAggregate(group=[{1}], agg#0=[sum($2)])
            HiveJoin(condition=[=($0, $3)], joinType=[inner], algorithm=[none], cost=[not available])
              HiveProject(ss_sold_date_sk=[$22], ss_customer_sk=[CAST($2):BIGINT NOT NULL], $f1=[*(CAST($9):DECIMAL(10, 0), $12)])
                HiveFilter(condition=[AND(IS NOT NULL($2), IS NOT NULL($22))])
                  HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales])
              HiveProject(d_date_sk=[$0])
                HiveFilter(condition=[SEARCH($6, Sarg[1999, 2000, 2001, 2002])])
                  HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])

CTE Suggestion:
HiveProject(d_date_sk=[$0], d_year=[CAST(1999):INTEGER], d_moy=[CAST(1):INTEGER])
  HiveFilter(condition=[AND(=($6, 1999), =($8, 1))])
    HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])

Warning: Map Join MAPJOIN[318][bigTable=?] in task 'Reducer 7' is a cross product
CBO PLAN:
HiveAggregate(group=[{}], agg#0=[sum($0)]): rowcount = 1.0, cumulative cost = {3.907819782098131E11 rows, 0.0 cpu, 0.0 io}, id = 26185
  HiveProject(sales=[$0]): rowcount = 2.700642292922948E7, cumulative cost = {3.907819782098131E11 rows, 0.0 cpu, 0.0 io}, id = 27171
    HiveUnion(all=[true]): rowcount = 2.700642292922948E7, cumulative cost = {3.907819782098131E11 rows, 0.0 cpu, 0.0 io}, id = 26183
      HiveProject(sales=[*(CAST($2):DECIMAL(10, 0), $3)]): rowcount = 1.796456999288107E7, cumulative cost = {2.0604471327040656E11 rows, 0.0 cpu, 0.0 io}, id = 26137
        HiveSemiJoin(condition=[=($0, $8)], joinType=[semi]): rowcount = 1.796456999288107E7, cumulative cost = {2.0604471327040656E11 rows, 0.0 cpu, 0.0 io}, id = 26135
          HiveSemiJoin(condition=[=($1, $8)], joinType=[semi]): rowcount = 1.796456999288107E7, cumulative cost = {1.2541120029067044E11 rows, 0.0 cpu, 0.0 io}, id = 26539
            HiveJoin(condition=[=($4, $5)], joinType=[inner], algorithm=[none], cost=[{4.2899393173590034E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.796456999288107E7, cumulative cost = {4.2899393173590034E10 rows, 0.0 cpu, 0.0 io}, id = 26067
              HiveProject(cs_bill_customer_sk=[$2], cs_item_sk=[$14], cs_quantity=[$17], cs_list_price=[$19], cs_sold_date_sk=[$33]): rowcount = 4.2899393143E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26060
                HiveFilter(condition=[AND(IS NOT NULL($2), IS NOT NULL($33))]): rowcount = 4.2899393143E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26058
                  HiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales]): rowcount = 4.3005109025E10, cumulative cost = {0}, id = 25560
              HiveProject(d_date_sk=[$0], d_year=[CAST(1999):INTEGER], d_moy=[CAST(1):INTEGER]): rowcount = 30.59003350083752, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26065
                HiveFilter(condition=[AND(=($6, 1999), =($8, 1))]): rowcount = 30.59003350083752, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26063
                  HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 25563
            HiveProject($f1=[$0]): rowcount = 3.333333334873333E14, cumulative cost = {8.25118071170804E10 rows, 0.0 cpu, 0.0 io}, id = 26536
              HiveFilter(condition=[>($2, 4)]): rowcount = 3.333333334873333E14, cumulative cost = {8.25118071170804E10 rows, 0.0 cpu, 0.0 io}, id = 26090
                HiveProject(i_item_sk=[$3], d_date=[$1], $f2=[$2]): rowcount = 1.000000000462E15, cumulative cost = {8.25118071170804E10 rows, 0.0 cpu, 0.0 io}, id = 26545
                  HiveJoin(condition=[=($0, $3)], joinType=[inner], algorithm=[none], cost=[{926811.0 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000462E15, cumulative cost = {8.25118071170804E10 rows, 0.0 cpu, 0.0 io}, id = 26532
                    HiveProject(ss_item_sk=[$0], d_date=[$1], $f2=[$2]): rowcount = 464811.0, cumulative cost = {8.25108803060804E10 rows, 0.0 cpu, 0.0 io}, id = 27172
                      HiveAggregate(group=[{0, 3}], agg#0=[count()]): rowcount = 464811.0, cumulative cost = {8.25108803060804E10 rows, 0.0 cpu, 0.0 io}, id = 26526
                        HiveJoin(condition=[=($1, $2)], joinType=[inner], algorithm=[none], cost=[{8.25108803060804E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 4.1462753738190955E8, cumulative cost = {8.25108803060804E10 rows, 0.0 cpu, 0.0 io}, id = 26079
                          HiveProject(ss_item_sk=[$1], ss_sold_date_sk=[$22]): rowcount = 8.2510879939E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26072
                            HiveFilter(condition=[IS NOT NULL($22)]): rowcount = 8.2510879939E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26070
                              HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.2510879939E10, cumulative cost = {0}, id = 25567
                          HiveProject(d_date_sk=[$0], d_date=[$2]): rowcount = 367.08040201005025, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26077
                            HiveFilter(condition=[SEARCH($6, Sarg[1999, 2000, 2001, 2002])]): rowcount = 367.08040201005025, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26075
                              HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 25570
                    HiveProject(i_item_sk=[$0]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26547
                      HiveTableScan(table=[[default, item]], table:alias=[item]): rowcount = 462000.0, cumulative cost = {0}, id = 25576
          HiveProject(c_customer_sk=[$0]): rowcount = 6.74916476557265E7, cumulative cost = {8.063351297973613E10 rows, 0.0 cpu, 0.0 io}, id = 26133
            HiveJoin(condition=[>($1, $2)], joinType=[inner], algorithm=[none], cost=[{6.74916486557265E7 rows, 0.0 cpu, 0.0 io}]): rowcount = 6.74916476557265E7, cumulative cost = {8.063351297973613E10 rows, 0.0 cpu, 0.0 io}, id = 26131
              HiveProject(ss_customer_sk=[$0], $f1=[$1]): rowcount = 6.74916476557265E7, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 27173
                HiveFilter(condition=[IS NOT NULL($1)]): rowcount = 6.74916476557265E7, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26105
                  HiveAggregate(group=[{0}], agg#0=[sum($1)]): rowcount = 7.8525965E7, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26103
                    HiveProject(ss_customer_sk=[CAST($2):BIGINT NOT NULL], $f1=[*(CAST($9):DECIMAL(10, 0), $12)]): rowcount = 8.2514936083E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26101
                      HiveFilter(condition=[IS NOT NULL($2)]): rowcount = 8.2514936083E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26099
                        HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.6404891377E10, cumulative cost = {0}, id = 25587
              HiveProject(EXPR$0=[*(0.95:DECIMAL(16, 6), $0)]): rowcount = 1.0, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26129
                HiveFilter(condition=[IS NOT NULL($0)]): rowcount = 1.0, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26127
                  HiveProject($f0=[$0]): rowcount = 1.0, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 27174
                    HiveAggregate(group=[{}], agg#0=[max($1)]): rowcount = 1.0, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26522
                      HiveProject(ss_customer_sk=[$0], $f1=[$1]): rowcount = 7.807313838715151E7, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 27175
                        HiveAggregate(group=[{1}], agg#0=[sum($2)]): rowcount = 7.807313838715151E7, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26524
                          HiveJoin(condition=[=($0, $3)], joinType=[inner], algorithm=[none], cost=[{8.05660213310804E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 4.048543767035176E8, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26117
                            HiveProject(ss_sold_date_sk=[$22], ss_customer_sk=[CAST($2):BIGINT NOT NULL], $f1=[*(CAST($9):DECIMAL(10, 0), $12)]): rowcount = 8.0566020964E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26110
                              HiveFilter(condition=[AND(IS NOT NULL($2), IS NOT NULL($22))]): rowcount = 8.0566020964E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26108
                                HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.2510879939E10, cumulative cost = {0}, id = 25594
                            HiveProject(d_date_sk=[$0]): rowcount = 367.08040201005025, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26115
                              HiveFilter(condition=[SEARCH($6, Sarg[1999, 2000, 2001, 2002])]): rowcount = 367.08040201005025, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26113
                                HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 25599
      HiveProject(sales=[*(CAST($2):DECIMAL(10, 0), $3)]): rowcount = 9041852.936348408, cumulative cost = {1.8473726493940656E11 rows, 0.0 cpu, 0.0 io}, id = 26181
        HiveSemiJoin(condition=[=($1, $8)], joinType=[semi]): rowcount = 9041852.936348408, cumulative cost = {1.8473726493940656E11 rows, 0.0 cpu, 0.0 io}, id = 26179
          HiveSemiJoin(condition=[=($0, $8)], joinType=[semi]): rowcount = 9041852.936348408, cumulative cost = {1.0410375195967044E11 rows, 0.0 cpu, 0.0 io}, id = 26543
            HiveJoin(condition=[=($4, $5)], joinType=[inner], algorithm=[none], cost=[{2.1591944842590034E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 9041852.936348408, cumulative cost = {2.1591944842590034E10 rows, 0.0 cpu, 0.0 io}, id = 26146
              HiveProject(ws_item_sk=[$2], ws_bill_customer_sk=[$3], ws_quantity=[$17], ws_list_price=[$19], ws_sold_date_sk=[$33]): rowcount = 2.1591944812E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26142
                HiveFilter(condition=[AND(IS NOT NULL($3), IS NOT NULL($33))]): rowcount = 2.1591944812E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26140
                  HiveTableScan(table=[[default, web_sales]], table:alias=[web_sales]): rowcount = 2.1594638446E10, cumulative cost = {0}, id = 25617
              HiveProject(d_date_sk=[$0], d_year=[CAST(1999):INTEGER], d_moy=[CAST(1):INTEGER]): rowcount = 30.59003350083752, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26065
                HiveFilter(condition=[AND(=($6, 1999), =($8, 1))]): rowcount = 30.59003350083752, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26063
                  HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 25563
            HiveProject($f1=[$0]): rowcount = 3.333333334873333E14, cumulative cost = {8.25118071170804E10 rows, 0.0 cpu, 0.0 io}, id = 26536
              HiveFilter(condition=[>($2, 4)]): rowcount = 3.333333334873333E14, cumulative cost = {8.25118071170804E10 rows, 0.0 cpu, 0.0 io}, id = 26090
                HiveProject(i_item_sk=[$3], d_date=[$1], $f2=[$2]): rowcount = 1.000000000462E15, cumulative cost = {8.25118071170804E10 rows, 0.0 cpu, 0.0 io}, id = 26545
                  HiveJoin(condition=[=($0, $3)], joinType=[inner], algorithm=[none], cost=[{926811.0 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000462E15, cumulative cost = {8.25118071170804E10 rows, 0.0 cpu, 0.0 io}, id = 26532
                    HiveProject(ss_item_sk=[$0], d_date=[$1], $f2=[$2]): rowcount = 464811.0, cumulative cost = {8.25108803060804E10 rows, 0.0 cpu, 0.0 io}, id = 27172
                      HiveAggregate(group=[{0, 3}], agg#0=[count()]): rowcount = 464811.0, cumulative cost = {8.25108803060804E10 rows, 0.0 cpu, 0.0 io}, id = 26526
                        HiveJoin(condition=[=($1, $2)], joinType=[inner], algorithm=[none], cost=[{8.25108803060804E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 4.1462753738190955E8, cumulative cost = {8.25108803060804E10 rows, 0.0 cpu, 0.0 io}, id = 26079
                          HiveProject(ss_item_sk=[$1], ss_sold_date_sk=[$22]): rowcount = 8.2510879939E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26072
                            HiveFilter(condition=[IS NOT NULL($22)]): rowcount = 8.2510879939E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26070
                              HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.2510879939E10, cumulative cost = {0}, id = 25567
                          HiveProject(d_date_sk=[$0], d_date=[$2]): rowcount = 367.08040201005025, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26077
                            HiveFilter(condition=[SEARCH($6, Sarg[1999, 2000, 2001, 2002])]): rowcount = 367.08040201005025, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26075
                              HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 25570
                    HiveProject(i_item_sk=[$0]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26547
                      HiveTableScan(table=[[default, item]], table:alias=[item]): rowcount = 462000.0, cumulative cost = {0}, id = 25576
          HiveProject(c_customer_sk=[$0]): rowcount = 6.74916476557265E7, cumulative cost = {8.063351297973613E10 rows, 0.0 cpu, 0.0 io}, id = 26133
            HiveJoin(condition=[>($1, $2)], joinType=[inner], algorithm=[none], cost=[{6.74916486557265E7 rows, 0.0 cpu, 0.0 io}]): rowcount = 6.74916476557265E7, cumulative cost = {8.063351297973613E10 rows, 0.0 cpu, 0.0 io}, id = 26131
              HiveProject(ss_customer_sk=[$0], $f1=[$1]): rowcount = 6.74916476557265E7, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 27173
                HiveFilter(condition=[IS NOT NULL($1)]): rowcount = 6.74916476557265E7, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26105
                  HiveAggregate(group=[{0}], agg#0=[sum($1)]): rowcount = 7.8525965E7, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26103
                    HiveProject(ss_customer_sk=[CAST($2):BIGINT NOT NULL], $f1=[*(CAST($9):DECIMAL(10, 0), $12)]): rowcount = 8.2514936083E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26101
                      HiveFilter(condition=[IS NOT NULL($2)]): rowcount = 8.2514936083E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26099
                        HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.6404891377E10, cumulative cost = {0}, id = 25587
              HiveProject(EXPR$0=[*(0.95:DECIMAL(16, 6), $0)]): rowcount = 1.0, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26129
                HiveFilter(condition=[IS NOT NULL($0)]): rowcount = 1.0, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26127
                  HiveProject($f0=[$0]): rowcount = 1.0, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 27174
                    HiveAggregate(group=[{}], agg#0=[max($1)]): rowcount = 1.0, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26522
                      HiveProject(ss_customer_sk=[$0], $f1=[$1]): rowcount = 7.807313838715151E7, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 27175
                        HiveAggregate(group=[{1}], agg#0=[sum($2)]): rowcount = 7.807313838715151E7, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26524
                          HiveJoin(condition=[=($0, $3)], joinType=[inner], algorithm=[none], cost=[{8.05660213310804E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 4.048543767035176E8, cumulative cost = {8.05660213310804E10 rows, 0.0 cpu, 0.0 io}, id = 26117
                            HiveProject(ss_sold_date_sk=[$22], ss_customer_sk=[CAST($2):BIGINT NOT NULL], $f1=[*(CAST($9):DECIMAL(10, 0), $12)]): rowcount = 8.0566020964E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26110
                              HiveFilter(condition=[AND(IS NOT NULL($2), IS NOT NULL($22))]): rowcount = 8.0566020964E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26108
                                HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.2510879939E10, cumulative cost = {0}, id = 25594
                            HiveProject(d_date_sk=[$0]): rowcount = 367.08040201005025, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26115
                              HiveFilter(condition=[SEARCH($6, Sarg[1999, 2000, 2001, 2002])]): rowcount = 367.08040201005025, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 26113
                                HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 25599

