CTE Suggestion:
HiveAggregate(group=[{5, 6, 8, 10, 11}], agg#0=[sum($2)])
  HiveJoin(condition=[=($1, $9)], joinType=[inner], algorithm=[none], cost=[not available])
    HiveJoin(condition=[=($7, $0)], joinType=[inner], algorithm=[none], cost=[not available])
      HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[not available])
        HiveProject(cs_call_center_sk=[$10], cs_item_sk=[$14], cs_sales_price=[$20], cs_sold_date_sk=[$33])
          HiveFilter(condition=[AND(IS NOT NULL($33), IS NOT NULL($10))])
            HiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales])
        HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8])
          HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))])
            HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])
      HiveProject(cc_call_center_sk=[$0], cc_name=[$6])
        HiveFilter(condition=[IS NOT NULL($6)])
          HiveTableScan(table=[[default, call_center]], table:alias=[call_center])
    HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12])
      HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))])
        HiveTableScan(table=[[default, item]], table:alias=[item])

CTE Suggestion:
HiveFilter(condition=[IS NOT NULL($4)])
  HiveProject((tok_table_or_col i_category)=[$4], (tok_table_or_col i_brand)=[$3], (tok_table_or_col cc_name)=[$2], (tok_function sum (tok_table_or_col cs_sales_price))=[$5], rank_window_1=[rank() OVER (PARTITION BY $4, $3, $2 ORDER BY $0 NULLS LAST, $1 NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)])
    HiveAggregate(group=[{5, 6, 8, 10, 11}], agg#0=[sum($2)])
      HiveJoin(condition=[=($1, $9)], joinType=[inner], algorithm=[none], cost=[not available])
        HiveJoin(condition=[=($7, $0)], joinType=[inner], algorithm=[none], cost=[not available])
          HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[not available])
            HiveProject(cs_call_center_sk=[$10], cs_item_sk=[$14], cs_sales_price=[$20], cs_sold_date_sk=[$33])
              HiveFilter(condition=[AND(IS NOT NULL($33), IS NOT NULL($10))])
                HiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales])
            HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8])
              HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))])
                HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])
          HiveProject(cc_call_center_sk=[$0], cc_name=[$6])
            HiveFilter(condition=[IS NOT NULL($6)])
              HiveTableScan(table=[[default, call_center]], table:alias=[call_center])
        HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12])
          HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))])
            HiveTableScan(table=[[default, item]], table:alias=[item])

CBO PLAN:
HiveProject(i_category=[$0], i_brand=[$1], d_year=[$2], d_moy=[$3], avg_monthly_sales=[$4], sum_sales=[$5], psum=[$6], nsum=[$7]): rowcount = 1.0, cumulative cost = {1.0000429001765176E15 rows, 0.0 cpu, 0.0 io}, id = 76287
  HiveSortLimit(sort0=[$8], sort1=[$2], dir0=[ASC], dir1=[ASC], fetch=[100]): rowcount = 1.0, cumulative cost = {1.0000429001765176E15 rows, 0.0 cpu, 0.0 io}, id = 76286
    HiveProject(i_category=[$10], i_brand=[$11], d_year=[$13], d_moy=[$14], avg_monthly_sales=[$16], sum_sales=[$15], psum=[$8], nsum=[$3], (- (tok_table_or_col sum_sales) (tok_table_or_col avg_monthly_sales))1=[-($15, $16)]): rowcount = 1.0, cumulative cost = {1.0000429001765176E15 rows, 0.0 cpu, 0.0 io}, id = 76285
      HiveJoin(condition=[AND(=($10, $0), =($11, $1), =($12, $2), =($17, $4))], joinType=[inner], algorithm=[none], cost=[{2.0 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.0, cumulative cost = {1.0000429001765176E15 rows, 0.0 cpu, 0.0 io}, id = 76284
        HiveProject((tok_table_or_col i_category)=[$0], (tok_table_or_col i_brand)=[$1], (tok_table_or_col cc_name)=[$2], (tok_function sum (tok_table_or_col cs_sales_price))=[$3], EXPR$0=[-($4, 1)]): rowcount = 1.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76263
          HiveFilter(condition=[IS NOT NULL($4)]): rowcount = 1.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76262
            HiveProject((tok_table_or_col i_category)=[$4], (tok_table_or_col i_brand)=[$3], (tok_table_or_col cc_name)=[$2], (tok_function sum (tok_table_or_col cs_sales_price))=[$5], rank_window_1=[rank() OVER (PARTITION BY $4, $3, $2 ORDER BY $0 NULLS LAST, $1 NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76261
              HiveProject(d_year=[$0], d_moy=[$1], cc_name=[$2], i_brand=[$3], i_category=[$4], $f5=[$5]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76288
                HiveAggregate(group=[{5, 6, 8, 10, 11}], agg#0=[sum($2)]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76260
                  HiveJoin(condition=[=($1, $9)], joinType=[inner], algorithm=[none], cost=[{1.00000000046206E15 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000462E15, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76259
                    HiveJoin(condition=[=($7, $0)], joinType=[inner], algorithm=[none], cost=[{2161104.9507664363 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.00000000000006E15, cumulative cost = {4.2899714453630745E10 rows, 0.0 cpu, 0.0 io}, id = 76258
                      HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[{4.289755334867998E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 2161044.9507664363, cumulative cost = {4.289755334867998E10 rows, 0.0 cpu, 0.0 io}, id = 76257
                        HiveProject(cs_call_center_sk=[$10], cs_item_sk=[$14], cs_sales_price=[$20], cs_sold_date_sk=[$33]): rowcount = 4.2897553345E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 76256
                          HiveFilter(condition=[AND(IS NOT NULL($10), IS NOT NULL($33))]): rowcount = 4.2897553345E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 76255
                            HiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales]): rowcount = 4.3005109025E10, cumulative cost = {0}, id = 75144
                        HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8]): rowcount = 3.679980798413933, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75527
                          HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))]): rowcount = 3.679980798413933, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75525
                            HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 75149
                      HiveProject(cc_call_center_sk=[$0], cc_name=[$6]): rowcount = 60.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75534
                        HiveFilter(condition=[IS NOT NULL($6)]): rowcount = 60.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75532
                          HiveTableScan(table=[[default, call_center]], table:alias=[call_center]): rowcount = 60.0, cumulative cost = {0}, id = 75154
                    HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75541
                      HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75539
                        HiveTableScan(table=[[default, item]], table:alias=[item]): rowcount = 462000.0, cumulative cost = {0}, id = 75141
        HiveJoin(condition=[AND(=($5, $0), =($6, $1), =($7, $2), =($12, $4))], joinType=[inner], algorithm=[none], cost=[{2.0 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.0, cumulative cost = {1.0000429001765156E15 rows, 0.0 cpu, 0.0 io}, id = 76283
          HiveProject((tok_table_or_col i_category)=[$0], (tok_table_or_col i_brand)=[$1], (tok_table_or_col cc_name)=[$2], (tok_function sum (tok_table_or_col cs_sales_price))=[$3], EXPR$0=[+($4, 1)]): rowcount = 1.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76273
            HiveFilter(condition=[IS NOT NULL($4)]): rowcount = 1.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76272
              HiveProject((tok_table_or_col i_category)=[$4], (tok_table_or_col i_brand)=[$3], (tok_table_or_col cc_name)=[$2], (tok_function sum (tok_table_or_col cs_sales_price))=[$5], rank_window_1=[rank() OVER (PARTITION BY $4, $3, $2 ORDER BY $0 NULLS LAST, $1 NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76271
                HiveProject(d_year=[$0], d_moy=[$1], cc_name=[$2], i_brand=[$3], i_category=[$4], $f5=[$5]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76289
                  HiveAggregate(group=[{5, 6, 8, 10, 11}], agg#0=[sum($2)]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76270
                    HiveJoin(condition=[=($1, $9)], joinType=[inner], algorithm=[none], cost=[{1.00000000046206E15 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000462E15, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76269
                      HiveJoin(condition=[=($7, $0)], joinType=[inner], algorithm=[none], cost=[{2161104.9507664363 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.00000000000006E15, cumulative cost = {4.2899714453630745E10 rows, 0.0 cpu, 0.0 io}, id = 76268
                        HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[{4.289755334867998E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 2161044.9507664363, cumulative cost = {4.289755334867998E10 rows, 0.0 cpu, 0.0 io}, id = 76267
                          HiveProject(cs_call_center_sk=[$10], cs_item_sk=[$14], cs_sales_price=[$20], cs_sold_date_sk=[$33]): rowcount = 4.2897553345E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 76266
                            HiveFilter(condition=[AND(IS NOT NULL($10), IS NOT NULL($33))]): rowcount = 4.2897553345E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 76265
                              HiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales]): rowcount = 4.3005109025E10, cumulative cost = {0}, id = 75144
                          HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8]): rowcount = 3.679980798413933, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75527
                            HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))]): rowcount = 3.679980798413933, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75525
                              HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 75149
                        HiveProject(cc_call_center_sk=[$0], cc_name=[$6]): rowcount = 60.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75534
                          HiveFilter(condition=[IS NOT NULL($6)]): rowcount = 60.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75532
                            HiveTableScan(table=[[default, call_center]], table:alias=[call_center]): rowcount = 60.0, cumulative cost = {0}, id = 75154
                      HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75541
                        HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75539
                          HiveTableScan(table=[[default, item]], table:alias=[item]): rowcount = 462000.0, cumulative cost = {0}, id = 75141
          HiveProject((tok_table_or_col i_category)=[$0], (tok_table_or_col i_brand)=[$1], (tok_table_or_col cc_name)=[$2], (tok_table_or_col d_year)=[$3], (tok_table_or_col d_moy)=[$4], (tok_function sum (tok_table_or_col cs_sales_price))=[$5], avg_window_0=[$6], rank_window_1=[$7]): rowcount = 1.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76290
            HiveFilter(condition=[AND(=($3, 2000), >($6, 0:DECIMAL(1, 0)), CASE(>($6, 0:DECIMAL(1, 0)), >(/(ABS(-($5, $6)), $6), 0.1:DECIMAL(1, 1)), false), IS NOT NULL($7))]): rowcount = 1.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76282
              HiveProject((tok_table_or_col i_category)=[$4], (tok_table_or_col i_brand)=[$3], (tok_table_or_col cc_name)=[$2], (tok_table_or_col d_year)=[$0], (tok_table_or_col d_moy)=[$1], (tok_function sum (tok_table_or_col cs_sales_price))=[$5], avg_window_0=[avg($5) OVER (PARTITION BY $4, $3, $2, $0 ORDER BY $4 NULLS FIRST, $3 NULLS FIRST, $2 NULLS FIRST, $0 NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)], rank_window_1=[rank() OVER (PARTITION BY $4, $3, $2 ORDER BY $0 NULLS LAST, $1 NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76281
                HiveProject(d_year=[$0], d_moy=[$1], cc_name=[$2], i_brand=[$3], i_category=[$4], $f5=[$5]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76291
                  HiveAggregate(group=[{5, 6, 8, 10, 11}], agg#0=[sum($2)]): rowcount = 8162.0, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76280
                    HiveJoin(condition=[=($1, $9)], joinType=[inner], algorithm=[none], cost=[{1.00000000046206E15 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000462E15, cumulative cost = {1.0000429001765136E15 rows, 0.0 cpu, 0.0 io}, id = 76279
                      HiveJoin(condition=[=($7, $0)], joinType=[inner], algorithm=[none], cost=[{2161104.9507664363 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.00000000000006E15, cumulative cost = {4.2899714453630745E10 rows, 0.0 cpu, 0.0 io}, id = 76278
                        HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[{4.289755334867998E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 2161044.9507664363, cumulative cost = {4.289755334867998E10 rows, 0.0 cpu, 0.0 io}, id = 76277
                          HiveProject(cs_call_center_sk=[$10], cs_item_sk=[$14], cs_sales_price=[$20], cs_sold_date_sk=[$33]): rowcount = 4.2897553345E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 76276
                            HiveFilter(condition=[AND(IS NOT NULL($10), IS NOT NULL($33))]): rowcount = 4.2897553345E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 76275
                              HiveTableScan(table=[[default, catalog_sales]], table:alias=[catalog_sales]): rowcount = 4.3005109025E10, cumulative cost = {0}, id = 75144
                          HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8]): rowcount = 3.679980798413933, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75527
                            HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))]): rowcount = 3.679980798413933, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75525
                              HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 75149
                        HiveProject(cc_call_center_sk=[$0], cc_name=[$6]): rowcount = 60.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75534
                          HiveFilter(condition=[IS NOT NULL($6)]): rowcount = 60.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75532
                            HiveTableScan(table=[[default, call_center]], table:alias=[call_center]): rowcount = 60.0, cumulative cost = {0}, id = 75154
                      HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75541
                        HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 75539
                          HiveTableScan(table=[[default, item]], table:alias=[item]): rowcount = 462000.0, cumulative cost = {0}, id = 75141

