CTE Suggestion:
HiveAggregate(group=[{5, 6, 8, 9, 11, 12}], agg#0=[sum($2)])
  HiveJoin(condition=[=($0, $10)], joinType=[inner], algorithm=[none], cost=[not available])
    HiveJoin(condition=[=($1, $7)], joinType=[inner], algorithm=[none], cost=[not available])
      HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[not available])
        HiveProject(ss_item_sk=[$1], ss_store_sk=[$6], ss_sales_price=[$12], ss_sold_date_sk=[$22])
          HiveFilter(condition=[AND(IS NOT NULL($22), IS NOT NULL($6))])
            HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales])
        HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8])
          HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))])
            HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])
      HiveProject(s_store_sk=[$0], s_store_name=[$5], s_company_name=[$17])
        HiveFilter(condition=[AND(IS NOT NULL($5), IS NOT NULL($17))])
          HiveTableScan(table=[[default, store]], table:alias=[store])
    HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12])
      HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))])
        HiveTableScan(table=[[default, item]], table:alias=[item])

CTE Suggestion:
HiveFilter(condition=[IS NOT NULL($5)])
  HiveProject((tok_table_or_col i_category)=[$5], (tok_table_or_col i_brand)=[$4], (tok_table_or_col s_store_name)=[$2], (tok_table_or_col s_company_name)=[$3], (tok_function sum (tok_table_or_col ss_sales_price))=[$6], rank_window_1=[rank() OVER (PARTITION BY $5, $4, $2, $3 ORDER BY $0 NULLS LAST, $1 NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)])
    HiveAggregate(group=[{5, 6, 8, 9, 11, 12}], agg#0=[sum($2)])
      HiveJoin(condition=[=($0, $10)], joinType=[inner], algorithm=[none], cost=[not available])
        HiveJoin(condition=[=($1, $7)], joinType=[inner], algorithm=[none], cost=[not available])
          HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[not available])
            HiveProject(ss_item_sk=[$1], ss_store_sk=[$6], ss_sales_price=[$12], ss_sold_date_sk=[$22])
              HiveFilter(condition=[AND(IS NOT NULL($22), IS NOT NULL($6))])
                HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales])
            HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8])
              HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))])
                HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim])
          HiveProject(s_store_sk=[$0], s_store_name=[$5], s_company_name=[$17])
            HiveFilter(condition=[AND(IS NOT NULL($5), IS NOT NULL($17))])
              HiveTableScan(table=[[default, store]], table:alias=[store])
        HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12])
          HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))])
            HiveTableScan(table=[[default, item]], table:alias=[item])

CBO PLAN:
HiveProject(i_category=[$0], d_year=[$1], d_moy=[$2], avg_monthly_sales=[$3], sum_sales=[$4], psum=[$5], nsum=[$6]): rowcount = 1.0, cumulative cost = {1.0000805879554468E15 rows, 0.0 cpu, 0.0 io}, id = 61555
  HiveSortLimit(sort0=[$7], sort1=[$2], dir0=[ASC], dir1=[ASC], fetch=[100]): rowcount = 1.0, cumulative cost = {1.0000805879554468E15 rows, 0.0 cpu, 0.0 io}, id = 61554
    HiveProject(i_category=[$12], d_year=[$16], d_moy=[$17], avg_monthly_sales=[$19], sum_sales=[$18], psum=[$10], nsum=[$4], (- (tok_table_or_col sum_sales) (tok_table_or_col avg_monthly_sales))1=[-($18, $19)]): rowcount = 1.0, cumulative cost = {1.0000805879554468E15 rows, 0.0 cpu, 0.0 io}, id = 61553
      HiveJoin(condition=[AND(=($12, $0), =($13, $1), =($14, $2), =($15, $3), =($20, $5))], joinType=[inner], algorithm=[none], cost=[{2.0 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.0, cumulative cost = {1.0000805879554468E15 rows, 0.0 cpu, 0.0 io}, id = 61552
        HiveProject((tok_table_or_col i_category)=[$0], (tok_table_or_col i_brand)=[$1], (tok_table_or_col s_store_name)=[$2], (tok_table_or_col s_company_name)=[$3], (tok_function sum (tok_table_or_col ss_sales_price))=[$4], EXPR$0=[-($5, 1)]): rowcount = 1.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61531
          HiveFilter(condition=[IS NOT NULL($5)]): rowcount = 1.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61530
            HiveProject((tok_table_or_col i_category)=[$5], (tok_table_or_col i_brand)=[$4], (tok_table_or_col s_store_name)=[$2], (tok_table_or_col s_company_name)=[$3], (tok_function sum (tok_table_or_col ss_sales_price))=[$6], rank_window_1=[rank() OVER (PARTITION BY $5, $4, $2, $3 ORDER BY $0 NULLS LAST, $1 NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61529
              HiveProject(d_year=[$0], d_moy=[$1], s_store_name=[$2], s_company_name=[$3], i_brand=[$4], i_category=[$5], $f6=[$6]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61556
                HiveAggregate(group=[{5, 6, 8, 9, 11, 12}], agg#0=[sum($2)]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61528
                  HiveJoin(condition=[=($0, $10)], joinType=[inner], algorithm=[none], cost=[{1.000000000463704E15 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000462E15, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61527
                    HiveJoin(condition=[=($1, $7)], joinType=[inner], algorithm=[none], cost=[{1.8251090186014682E7 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000001704E15, cumulative cost = {8.058749173873203E10 rows, 0.0 cpu, 0.0 io}, id = 61526
                      HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[{8.0569240648546E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.8249386186014682E7, cumulative cost = {8.0569240648546E10 rows, 0.0 cpu, 0.0 io}, id = 61525
                        HiveProject(ss_item_sk=[$1], ss_store_sk=[$6], ss_sales_price=[$12], ss_sold_date_sk=[$22]): rowcount = 8.0569240632E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 61524
                          HiveFilter(condition=[AND(IS NOT NULL($6), IS NOT NULL($22))]): rowcount = 8.0569240632E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 61523
                            HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.2510879939E10, cumulative cost = {0}, id = 60412
                        HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8]): rowcount = 16.546009383297008, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60795
                          HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))]): rowcount = 16.546009383297008, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60793
                            HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 60417
                      HiveProject(s_store_sk=[$0], s_store_name=[$5], s_company_name=[$17]): rowcount = 1704.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60802
                        HiveFilter(condition=[AND(IS NOT NULL($5), IS NOT NULL($17))]): rowcount = 1704.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60800
                          HiveTableScan(table=[[default, store]], table:alias=[store]): rowcount = 1704.0, cumulative cost = {0}, id = 60422
                    HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60809
                      HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60807
                        HiveTableScan(table=[[default, item]], table:alias=[item]): rowcount = 462000.0, cumulative cost = {0}, id = 60409
        HiveJoin(condition=[AND(=($6, $0), =($7, $1), =($8, $2), =($9, $3), =($14, $5))], joinType=[inner], algorithm=[none], cost=[{2.0 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.0, cumulative cost = {1.0000805879554448E15 rows, 0.0 cpu, 0.0 io}, id = 61551
          HiveProject((tok_table_or_col i_category)=[$0], (tok_table_or_col i_brand)=[$1], (tok_table_or_col s_store_name)=[$2], (tok_table_or_col s_company_name)=[$3], (tok_function sum (tok_table_or_col ss_sales_price))=[$4], EXPR$0=[+($5, 1)]): rowcount = 1.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61541
            HiveFilter(condition=[IS NOT NULL($5)]): rowcount = 1.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61540
              HiveProject((tok_table_or_col i_category)=[$5], (tok_table_or_col i_brand)=[$4], (tok_table_or_col s_store_name)=[$2], (tok_table_or_col s_company_name)=[$3], (tok_function sum (tok_table_or_col ss_sales_price))=[$6], rank_window_1=[rank() OVER (PARTITION BY $5, $4, $2, $3 ORDER BY $0 NULLS LAST, $1 NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61539
                HiveProject(d_year=[$0], d_moy=[$1], s_store_name=[$2], s_company_name=[$3], i_brand=[$4], i_category=[$5], $f6=[$6]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61557
                  HiveAggregate(group=[{5, 6, 8, 9, 11, 12}], agg#0=[sum($2)]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61538
                    HiveJoin(condition=[=($0, $10)], joinType=[inner], algorithm=[none], cost=[{1.000000000463704E15 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000462E15, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61537
                      HiveJoin(condition=[=($1, $7)], joinType=[inner], algorithm=[none], cost=[{1.8251090186014682E7 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000001704E15, cumulative cost = {8.058749173873203E10 rows, 0.0 cpu, 0.0 io}, id = 61536
                        HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[{8.0569240648546E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.8249386186014682E7, cumulative cost = {8.0569240648546E10 rows, 0.0 cpu, 0.0 io}, id = 61535
                          HiveProject(ss_item_sk=[$1], ss_store_sk=[$6], ss_sales_price=[$12], ss_sold_date_sk=[$22]): rowcount = 8.0569240632E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 61534
                            HiveFilter(condition=[AND(IS NOT NULL($6), IS NOT NULL($22))]): rowcount = 8.0569240632E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 61533
                              HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.2510879939E10, cumulative cost = {0}, id = 60412
                          HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8]): rowcount = 16.546009383297008, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60795
                            HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))]): rowcount = 16.546009383297008, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60793
                              HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 60417
                        HiveProject(s_store_sk=[$0], s_store_name=[$5], s_company_name=[$17]): rowcount = 1704.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60802
                          HiveFilter(condition=[AND(IS NOT NULL($5), IS NOT NULL($17))]): rowcount = 1704.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60800
                            HiveTableScan(table=[[default, store]], table:alias=[store]): rowcount = 1704.0, cumulative cost = {0}, id = 60422
                      HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60809
                        HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60807
                          HiveTableScan(table=[[default, item]], table:alias=[item]): rowcount = 462000.0, cumulative cost = {0}, id = 60409
          HiveProject((tok_table_or_col i_category)=[$0], (tok_table_or_col i_brand)=[$1], (tok_table_or_col s_store_name)=[$2], (tok_table_or_col s_company_name)=[$3], (tok_table_or_col d_year)=[$4], (tok_table_or_col d_moy)=[$5], (tok_function sum (tok_table_or_col ss_sales_price))=[$6], avg_window_0=[$7], rank_window_1=[$8]): rowcount = 1.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61558
            HiveFilter(condition=[AND(=($4, 2000), >($7, 0:DECIMAL(1, 0)), CASE(>($7, 0:DECIMAL(1, 0)), >(/(ABS(-($6, $7)), $7), 0.1:DECIMAL(1, 1)), false), IS NOT NULL($8))]): rowcount = 1.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61550
              HiveProject((tok_table_or_col i_category)=[$5], (tok_table_or_col i_brand)=[$4], (tok_table_or_col s_store_name)=[$2], (tok_table_or_col s_company_name)=[$3], (tok_table_or_col d_year)=[$0], (tok_table_or_col d_moy)=[$1], (tok_function sum (tok_table_or_col ss_sales_price))=[$6], avg_window_0=[avg($6) OVER (PARTITION BY $5, $4, $2, $3, $0 ORDER BY $5 NULLS FIRST, $4 NULLS FIRST, $2 NULLS FIRST, $3 NULLS FIRST, $0 NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)], rank_window_1=[rank() OVER (PARTITION BY $5, $4, $2, $3 ORDER BY $0 NULLS LAST, $1 NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61549
                HiveProject(d_year=[$0], d_moy=[$1], s_store_name=[$2], s_company_name=[$3], i_brand=[$4], i_category=[$5], $f6=[$6]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61559
                  HiveAggregate(group=[{5, 6, 8, 9, 11, 12}], agg#0=[sum($2)]): rowcount = 8162.0, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61548
                    HiveJoin(condition=[=($0, $10)], joinType=[inner], algorithm=[none], cost=[{1.000000000463704E15 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000462E15, cumulative cost = {1.0000805879554428E15 rows, 0.0 cpu, 0.0 io}, id = 61547
                      HiveJoin(condition=[=($1, $7)], joinType=[inner], algorithm=[none], cost=[{1.8251090186014682E7 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.000000000001704E15, cumulative cost = {8.058749173873203E10 rows, 0.0 cpu, 0.0 io}, id = 61546
                        HiveJoin(condition=[=($3, $4)], joinType=[inner], algorithm=[none], cost=[{8.0569240648546E10 rows, 0.0 cpu, 0.0 io}]): rowcount = 1.8249386186014682E7, cumulative cost = {8.0569240648546E10 rows, 0.0 cpu, 0.0 io}, id = 61545
                          HiveProject(ss_item_sk=[$1], ss_store_sk=[$6], ss_sales_price=[$12], ss_sold_date_sk=[$22]): rowcount = 8.0569240632E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 61544
                            HiveFilter(condition=[AND(IS NOT NULL($6), IS NOT NULL($22))]): rowcount = 8.0569240632E10, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 61543
                              HiveTableScan(table=[[default, store_sales]], table:alias=[store_sales]): rowcount = 8.2510879939E10, cumulative cost = {0}, id = 60412
                          HiveProject(d_date_sk=[$0], d_year=[$6], d_moy=[$8]): rowcount = 16.546009383297008, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60795
                            HiveFilter(condition=[AND(SEARCH($6, Sarg[1999, 2000, 2001]), OR(=($6, 2000), SEARCH(ROW($6, $8), Sarg[[1999:INTEGER, 12:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1), [2001:INTEGER, 1:INTEGER]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1)]:RecordType(INTEGER NOT NULL EXPR$0, INTEGER NOT NULL EXPR$1))))]): rowcount = 16.546009383297008, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60793
                              HiveTableScan(table=[[default, date_dim]], table:alias=[date_dim]): rowcount = 73049.0, cumulative cost = {0}, id = 60417
                        HiveProject(s_store_sk=[$0], s_store_name=[$5], s_company_name=[$17]): rowcount = 1704.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60802
                          HiveFilter(condition=[AND(IS NOT NULL($5), IS NOT NULL($17))]): rowcount = 1704.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60800
                            HiveTableScan(table=[[default, store]], table:alias=[store]): rowcount = 1704.0, cumulative cost = {0}, id = 60422
                      HiveProject(i_item_sk=[$0], i_brand=[$8], i_category=[$12]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60809
                        HiveFilter(condition=[AND(IS NOT NULL($12), IS NOT NULL($8))]): rowcount = 462000.0, cumulative cost = {0.0 rows, 0.0 cpu, 0.0 io}, id = 60807
                          HiveTableScan(table=[[default, item]], table:alias=[item]): rowcount = 462000.0, cumulative cost = {0}, id = 60409

